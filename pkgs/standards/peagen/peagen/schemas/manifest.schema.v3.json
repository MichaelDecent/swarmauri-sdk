{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://peagen.dev/schemas/manifest-v3.json",
  "title": "Peagen Manifest (schema_version 3)",
  "type": "object",
  "required": [
    "schema_version",
    "workspace_uri",
    "project",
    "generated",
    "source_packages",
    "peagen_version",
    "generated_at"
  ],

  "properties": {
    "schema_version": {
      "const": 3,
      "description": "Hard-coded version tag; bump only on breaking changes."
    },

    "workspace_uri": {
      "type": "string",
      "description": "Fetchable root location of the rendered workspace.\n"
                   + "  • file://<abs-path>          (local run)\n"
                   + "  • minio://host:port/bucket[/prefix]/\n"
                   + "  • s3://bucket[/prefix]/\n"
                   + "  • gh://owner/repo[/prefix]/ (GitHub Contents API)\n"
                   + "The evaluator picks an adapter based on the URI scheme."
    },

    "project": {
      "type": "string",
      "description": "Human-readable project name taken from payload `NAME`."
    },

    "generated": {
      "type": "array",
      "description": "Relative paths of all files Peagen CREATED or OVERWROTE "
                   + "during this run. Paths are always Unix-style (`/`).",
      "items": { "type": "string" }
    },

    "source_packages": {
      "type": "array",
      "description": "External code/material that was cloned or copied into "
                   + "the workspace _before_ rendering began. Evaluators must "
                   + "materialise these the same way to reconstruct the full tree.",
      "items": {
        "type": "object",
        "required": ["type", "dest"],
        "properties": {
          "type": {
            "enum": ["git", "local"],
            "description": "git = clone from remote; local = copy from path."
          },
          "uri": {
            "type": "string",
            "description": "HTTPS or SSH URI for git packages."
          },
          "ref": {
            "type": "string",
            "description": "Tag, branch, or commit SHA. Optional for git."
          },
          "path": {
            "type": "string",
            "description": "Absolute or relative path for local packages."
          },
          "dest": {
            "type": "string",
            "description": "Destination folder **inside** workspace (Unix style)."
          },
          "checksum": {
            "type": "string",
            "description": "Optional sha256 or similar for byte-level reproducibility."
          }
        },
        "allOf": [
          {
            "if": { "properties": { "type": { "const": "git" } } },
            "then": { "required": ["uri"] }
          },
          {
            "if": { "properties": { "type": { "const": "local" } } },
            "then": { "required": ["path"] }
          }
        ],
        "additionalProperties": false
      }
    },

    "peagen_version": {
      "type": "string",
      "description": "Semantic version of the Peagen CLI that produced the manifest."
    },

    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp (ISO-8601) when rendering finished."
    }
  },

  "additionalProperties": false
}
